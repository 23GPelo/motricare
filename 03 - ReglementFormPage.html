<!DOCTYPE html>
<html>
  <head>
    <?!= include('Stylesheet'); ?>
  </head>
  <body>
    <label for="patients">Patient :</label>
    <select name="patients" id="patients">
      <? for(var i = 0; i < patients.length; i++){ ?>
        <option value="<?= patients[i] ?>"><?= patients[i] ?></option>        
      <? } ?>
    </select> 
    <br><br>
    <div>
      <? for(var i = 0; i < factures.length; i++){
        var re = new RegExp(/FA\d{2}-\d{4}/g)
        if(re.test(factures[i].number)){ ?>
          <div style="display:none" class="box" id="<?= factures[i].patient ?>">
            <input type="checkbox" class="factures" value="<?= factures[i].id ?>">
            <label><?= factures[i].number ?> - <?= factures[i].amount ?> €</label>      
          </div> 
      <? }} ?>      
    </div>
    <br>
    <div style="inline-block" id="regles">
      <label for="reglements">Mode de réglement :</label>
      <select name="reglements" id="reglements">
        <? for(var j = 0; j < reglements.length; j++){ ?>
          <option value="<?= reglements[j].modalite ?>" ><?= reglements[j].modalite ?></option>        
        <? } ?>
      </select> 
      <br><br>
      <label for="amount">Montant :</label>
      <input type="number" id="amount" value="0" min="0" step="5">
    </div>

    <br><br><hr/><br>

    <input type="button" value="Générer" onclick="regler()">

    <span class="annuler" onclick="google.script.host.close()">Annuler</span>

    <p id="success" style="color:green; display:none;"></p>
    <p id="failure" style="color:red; display:none;"></p>    

    <script>
      function success(id){
        var textS = document.getElementById("success")
        var textF = document.getElementById("failure")

        textS.innerText = "Reglement "+id+" générée !"
        textS.style.display = "block";

        textF.style.display = "none";
      }

      function failure(error){
        var textS = document.getElementById("success")
        var textF = document.getElementById("failure")
        
        textS.style.display = "none";
        textF.innerText = "Erreur d'enregistrement de paiement ! "+error
        textF.style.display = "block";
      }

      function displayCheckboxes(){
        var selector = document.getElementById("patients");      
        var value = selector.options[selector.selectedIndex].value;
        var checkboxes = document.querySelectorAll('div.box');
        for (var checkbox of checkboxes) {
          checkbox.checked = false
          checkbox.style.display = checkbox.id == value ? "block" : "none"
        }
      }
      

      function regler() {
        var tab = []
        var checkboxes = document.querySelectorAll('input[type=checkbox]:checked');
        for (var checkbox of checkboxes) {
          tab.push(checkbox.value)
        }
        var mode = document.querySelector("#reglements").value
        var amount = document.querySelector("#amount").value
        var patientSelect = document.querySelector("#patients")
        var patient = patientSelect.options[patientSelect.selectedIndex].value
        Logger.log(amount)
        google.script.run.withSuccessHandler(success).withFailureHandler(failure).ajouterReglement(tab,mode,amount,patient);
      }
      
      /*
      var selector2 = document.querySelectorAll('input[type=checkbox]');
      for (var checkbox of checkboxes2) {
        checkbox.addEventListener('change', function() {
          if(this.checked){
            selector2.style.display = "inline-block"
          }else{
            selector2.style.display = "none"
          }
        });
      }
*/
      var selector = document.getElementById("patients");      
      selector.addEventListener("change", displayCheckboxes);
      displayCheckboxes()
     
    </script>
  </body>
</html>